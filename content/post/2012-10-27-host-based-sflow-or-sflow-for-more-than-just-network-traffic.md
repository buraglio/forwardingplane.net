---
id: 18
title: 'Host based sflow, or, sflow for more than just network traffic'
date: '2012-10-27T02:33:00-05:00'
author: buraglio
layout: post
guid: 'http://new.forwardingplane.net/2012/10/host-based-sflow-or-sflow-for-more-than-just-network-traffic/'
permalink: /2012/10/27/host-based-sflow-or-sflow-for-more-than-just-network-traffic/
blogger_blog:
    - www.forwardingplane.net
blogger_author:
    - 'Nick Buraglio'
blogger_permalink:
    - /2012/10/host-based-sflow-or-sflow-for-more-than.html
Views:
    - '69'
categories:
    - Routing
    - UNIX
---

I'm an awful sysadmin.  Running services permanently isn't really my forte, I tend to lean more on the "I'll get this proof of concept all working, prove that it works or doesn't, then roll it on for polishing by someone else" kinda guy.  That final 15% is something I'm constantly working to refine and better myself at accomplishing.   I'm decent at debugging network services, and can be handy in a "oh crap, it's down!" scamerio, but day to day sysadmin...not really my speciality.<br />I know enough programming to be dangerous and have enough experience to know how to set up or fix pretty much any OS with nearly any service on it.  15 years as a slash and burn Network Engineer will often lend itself to that.  That being said, I do enjoy playing with new options, software packages and and LOVE instrumentation.  Then I came across <a href="http://host-sflow.sourceforge.net/" target="_blank" rel="noopener noreferrer">this</a>.     <a href="http://blog.sflow.com/2012/01/host-sflow-distributed-agent.html" target="_blank" rel="noopener noreferrer">Host based sflow</a>.....for more than just network traffic.<br />This idea is <b><u>fantastic</u></b>. <br /><b>Why</b> did I never think of it?!?!?!?<br /><br />Essentially it's <a href="http://en.wikipedia.org/wiki/SFlow" target="_blank" rel="noopener noreferrer">sflow</a>, a mechanism for monitoring network traffic, or thats at least how I thought of it being from the network side.  It's a lot like Netflow, but an open standard.  Many network devices support it for sampling transit routed packets.  It never occured to me to run it on hosts for other things like.....http hits, disk utilization....memory usage.  This seems perfect for a cloud environment, or for a VM farm....or anywhere you don't want to run snmpd or some weird commercial agent on a host.<br />I already have an <a href="http://nfsen.sourceforge.net/" target="_blank" rel="noopener noreferrer">nfsen</a>/<a href="http://nfdump.sourceforge.net/" target="_blank" rel="noopener noreferrer">nfdump</a> instance, but it should work with any open source or commercial collector that supports sflow, which is a huge number.  Intermapper flow, inmon, there is a long list. <br /><br />I had to see this work, since we had just discussed this type of monitoring in our new [broadband project of the year award winning] ISP, <a href="http://www.uc2b.net/" target="_blank" rel="noopener noreferrer">UC2B</a> that I am heavily involved in. <br />So, on to the meat and potato..<br />I grabbed the dpkg and installed it on my personal ubuntu server. <br /><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i>sudo dpkg -i hsflowd_1.22.2-1_x86_64.deb </i></span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: inherit;">From there I needed to edit the conf file to point it my test flow collector, which happens to reside on the same box.  Use your favorite editor, I like vi personally but I've been using it for 15 years. </span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i>sudo vi /etc/hsflowd.conf</i></span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: inherit;">Change the following lines:</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i>DNSSD = off</i></span><br /><div><br /><br /> <span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i> polling = 30</i></span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i>  sampling.http = 10</i></span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i>  sampling.memcache = 500</i></span><br /><br /><br /><br /></div><div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i> collector {</i></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i>    ip = 127.0.0.1</i></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i>     udpport = 6997</i></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i>  }</i></span></div></div><div><br /></div><div>Close out the file.  I chose to tweak a few of the defaults to see what it'd yield.  </div><div><br /></div><div>Now edit your nfsen.conf file</div><br /><br /><br /><i><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">%sources = (</span></i><br /><i><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">    'home'    => { 'port' => '6996', 'col' => '#0000ff', 'type' => 'netflow' },</span></i><br /><i><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">    'cupcake'    => { 'port' => '6997', 'col' => '#0000ff', 'type' => 'sflow' },</span></i><br /><i><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">);</span></i><br /><br /><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i>sudo /services/netflow/bin/nfsen reconfig</i></span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: inherit;">This should yield at the very least network data and provide a proof of concept. other services can be monitored by using the json options, but that's beyond the scope of this writing.  I could see a big win from this in a home brew cloud environment or a large VM farm since it can provide a very straightforward way to generate very useful data in a standard format that can be very simply monitored, queried and archived.    </span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><a href="http://gan.doubleclick.net/gan_click?lid=41000000028007181&pid=UBM9786132095695&adurl=http%3A%2F%2Fwww.cdsbooksdvds.com%2Fproduct.jhtm%3Fsku%3DUBM9786132095695&usg=AFHzDLucmjq8niDqbnNmvyDzFPVpDnuqQQ&pubid=590157" rel="nofollow">Paessler Router Traffic Grapher</a></i></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><i><br /></i></span><br /><br /><div>[[ This is a content summary only. Visit my website for full links, other content, and more! ]]</div>